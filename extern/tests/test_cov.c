#include <minunit.h>
#include <stdio.h>
#include "../cov.h"

//declare variables in global scope for tests
#define N 3000
static double wl[N];
static double min_sep;
static cholmod_common c;

//setup function run before each test
void test_setup(void)
{
    //Create a sample array of wavelengths for testing purposes. 
    linspace(wl, N, 5100., 5200.); //initialize with wavelength values
    min_sep = get_min_sep(wl, N);
    //printf("min_sep = %.4f\n", min_sep);

    cholmod_start (&c) ; // start CHOLMOD
    c.print = 5;
}

void test_teardown(void)
{   
    // free all of the variables
    //cholmod_free_sparse(&A, &c); 
    //cholmod_free_factor(&L, &c);
    //cholmod_free_dense(&b, &c);
    //cholmod_free_dense(&x, &c);
    //cholmod_free_dense(&r, &c);
    cholmod_finish (&c) ;  // finish CHOLMOD 
}

MU_TEST(test_create_sigma)
{
    printf("\ntest_create_sigma\n");
    //note that the real function won't use wl, it will use sigma values. 
    //But since we already have this array declared, we will use it.
    cholmod_sparse *A = create_sigma(wl, N, &c);

    //cholmod_print_sparse(A, "A", &c);
    cholmod_free_sparse(&A, &c); 

}

MU_TEST(test_create_sparse)
{
    printf("\ntest_create_sparse\n");
    //See if the sparse matrix is allocated with the correct properties
    cholmod_sparse *A = create_sparse(wl, N, min_sep, 1.0, 1.0, &c);
    //Test to see what kind of matrix this is
    printf("stype of A = %d\n", A->stype);

    //cholmod_print_sparse(A, "A", &c);
    cholmod_free_sparse(&A, &c); 

}

MU_TEST(test_add_sigma_sparse)
{
    printf("\ntest_add_sigma_sparse\n");
    //Test out our adding methods

    cholmod_sparse *S = create_sigma(wl, N, &c);
    cholmod_sparse *A = create_sparse(wl, N, min_sep, 1.0, 1.0, &c);

    double alpha [2] = {1,0}, beta [2] = {1,0};  // basic scalars 
    cholmod_sparse *F = cholmod_add(S, A, alpha, beta, TRUE, TRUE, &c);

    //cholmod_print_sparse(F, "F", &c);
    cholmod_free_sparse(&S, &c); 
    cholmod_free_sparse(&A, &c); 
    cholmod_free_sparse(&F, &c); 

}

MU_TEST(test_factor)
{
    printf("\ntest_factor\n");
    cholmod_sparse *A = create_sparse(wl, N, min_sep, 1.0, 0.5, &c);
    cholmod_factor *L ;
    L = cholmod_analyze (A, &c) ;		    

    printf("is Supernodal factorization = %d\n", L->is_super);
    printf("LDL' = 0, LL' = 1; is_ll = %d\n", L->is_ll);
    printf("Status is = %d\n", c.status);
    
    //cholmod_print_perm(L->Perm, A->nrow, A->nrow, "Perm", &c);
    //cholmod_print_factor(L, "L", &c);
    cholmod_factorize (A, L, &c) ;		    
    printf("L->minor = %d\n", (int) L->minor);
    printf("rcond = %.7f\n", cholmod_rcond(L, &c));

    cholmod_free_sparse(&A, &c); 
    cholmod_free_factor(&L, &c);
}

MU_TEST(test_factor_real_wl)
{
    printf("\ntest_factor_real_wl\n");
    double wl[2298] = {5135.3213, 5135.3689, 5135.4165, 5135.4641, 5135.5117, 5135.5593, 5135.6069, 5135.6545, 5135.7021, 5135.7497, 5135.7973, 5135.8448, 5135.8924, 5135.9400, 5135.9876, 5136.0351, 5136.0827, 5136.1303, 5136.1778, 5136.2254, 5136.2729, 5136.3205, 5136.3680, 5136.4156, 5136.4631, 5136.5107, 5136.5582, 5136.6057, 5136.6533, 5136.7008, 5136.7483, 5136.7958, 5136.8433, 5136.8909, 5136.9384, 5136.9859, 5137.0334, 5137.0809, 5137.1284, 5137.1759, 5137.2234, 5137.2709, 5137.3183, 5137.3658, 5137.4133, 5137.4608, 5137.5083, 5137.5557, 5137.6032, 5137.6507, 5137.6981, 5137.7456, 5137.7930, 5137.8405, 5137.8879, 5137.9354, 5137.9828, 5138.0303, 5138.0777, 5138.1251, 5138.1726, 5138.2200, 5138.2674, 5138.3148, 5138.3623, 5138.4097, 5138.4571, 5138.5045, 5138.5519, 5138.5993, 5138.6467, 5138.6941, 5138.7415, 5138.7889, 5138.8363, 5138.8836, 5138.9310, 5138.9784, 5139.0258, 5139.0732, 5139.1205, 5139.1679, 5139.2152, 5139.2626, 5139.3100, 5139.3573, 5139.4047, 5139.4520, 5139.4994, 5139.5467, 5139.5940, 
5139.6414, 5139.6887, 5139.7360, 5139.7834, 5139.8307, 5139.8780, 5139.9253, 5139.9726, 5140.0199, 5140.0672, 5140.1145, 5140.1618, 5140.2091, 5140.2564, 5140.3037, 5140.3510, 5140.3983, 5140.4456, 5140.4929, 5140.5401, 5140.5874, 5140.6347, 5140.6820, 5140.7292, 5140.7765, 5140.8237, 5140.8710, 5140.9182, 5140.9655, 5141.0127, 5141.0600, 5141.1072, 5141.1544, 5141.2017, 5141.2489, 5141.2961, 5141.3434, 5141.3906, 5141.4378, 5141.4850, 5141.5322, 5141.5794, 5141.6266, 5141.6738, 5141.7210, 5141.7682, 5141.8154, 5141.8626, 5141.9098, 5141.9570, 5142.0042, 5142.0513, 5142.0985, 5142.1457, 5142.1928, 5142.2400, 5142.2872, 5142.3343, 5142.3815, 5142.4286, 5142.4758, 5142.5229, 5142.5701, 5142.6172, 5142.6643, 5142.7115, 5142.7586, 5142.8057, 5142.8529, 5142.9000, 5142.9471, 5142.9942, 5143.0413, 5143.0884, 5143.1355, 5143.1826, 5143.2297, 5143.2768, 5143.3239, 5143.3710, 5143.4181, 5143.4652, 5143.5123, 5143.5594, 5143.6064, 5143.6535, 5143.7006, 5143.7476, 5143.7947, 5143.8418, 5143.8888, 5143.9359, 5143.9829, 
5144.0300, 5144.0770, 5144.1240, 5144.1711, 5144.2181, 5144.2651, 5144.3122, 5144.3592, 5144.4062, 5144.4532, 5144.5002, 5144.5473, 5144.5943, 5144.6413, 5144.6883, 5144.7353, 5144.7823, 5144.8293, 5144.8763, 5144.9232, 5144.9702, 5145.0172, 5145.0642, 5145.1112, 5145.1581, 5145.2051, 5145.2521, 5145.2990, 5145.3460, 5145.3930, 5145.4399, 5145.4869, 5145.5338, 5145.5807, 5145.6277, 5145.6746, 5145.7216, 5145.7685, 5145.8154, 5145.8623, 5145.9093, 5145.9562, 5146.0031, 5146.0500, 5146.0969, 5146.1438, 5146.1907, 5146.2376, 5146.2845, 5146.3314, 5146.3783, 5146.4252, 5146.4721, 5146.5190, 5146.5658, 5146.6127, 5146.6596, 5146.7065, 5146.7533, 5146.8002, 5146.8471, 5146.8939, 5146.9408, 5146.9876, 5147.0345, 5147.0813, 5147.1281, 5147.1750, 5147.2218, 5147.2687, 5147.3155, 5147.3623, 5147.4091, 5147.4559, 5147.5028, 5147.5496, 5147.5964, 5147.6432, 5147.6900, 5147.7368, 5147.7836, 5147.8304, 5147.8772, 5147.9240, 5147.9708, 5148.0175, 5148.0643, 5148.1111, 5148.1579, 5148.2046, 5148.2514, 5148.2982, 5148.3449, 
5148.3917, 5148.4384, 5148.4852, 5148.5319, 5148.5787, 5148.6254, 5148.6722, 5148.7189, 5148.7656, 5148.8124, 5148.8591, 5148.9058, 5148.9525, 5148.9992, 5149.0459, 5149.0927, 5149.1394, 5149.1861, 5149.2328, 5149.2795, 5149.3262, 5149.3729, 5149.4195, 5149.4662, 5149.5129, 5149.5596, 5149.6063, 5149.6529, 5149.6996, 5149.7463, 5149.7929, 5149.8396, 5149.8863, 5149.9329, 5149.9796, 5150.0262, 5150.0729, 5150.1195, 5150.1661, 5150.2128, 5150.2594, 5150.3060, 5150.3527, 5150.3993, 5150.4459, 5150.4925, 5150.5391, 5150.5857, 5150.6323, 5150.6789, 5150.7255, 5150.7721, 5150.8187, 5150.8653, 5150.9119, 5150.9585, 5151.0051, 5151.0517, 5151.0982, 5151.1448, 5151.1914, 5151.2380, 5151.2845, 5151.3311, 5151.3776, 5151.4242, 5151.4707, 5151.5173, 5151.5638, 5151.6104, 5151.6569, 5151.7034, 5151.7500, 5151.7965, 5151.8430, 5151.8896, 5151.9361, 5151.9826, 5152.0291, 5152.0756, 5152.1221, 5152.1686, 5152.2151, 5152.2616, 5152.3081, 5152.3546, 5152.4011, 5152.4476, 5152.4941, 5152.5405, 5152.5870, 5152.6335, 5152.6800, 
5152.7264, 5152.7729, 5152.8193, 5152.8658, 5152.9123, 5152.9587, 5153.0052, 5153.0516, 5153.0980, 5153.1445, 5153.1909, 5153.2373, 5153.2838, 5153.3302, 5153.3766, 5153.4230, 5153.4695, 5153.5159, 5153.5623, 5153.6087, 5153.6551, 5153.7015, 5153.7479, 5153.7943, 5153.8407, 5153.8871, 5153.9334, 5153.9798, 5154.0262, 5154.0726, 5154.1190, 5154.1653, 5154.2117, 5154.2581, 5154.3044, 5154.3508, 5154.3971, 5154.4435, 5154.4898, 5154.5362, 5154.5825, 5154.6288, 5154.6752, 5154.7215, 5154.7678, 5154.8142, 5154.8605, 5154.9068, 5154.9531, 5154.9994, 5155.0457, 5155.0920, 5155.1384, 5155.1847, 5155.2309, 5155.2772, 5155.3235, 5155.3698, 5155.4161, 5155.4624, 5155.5087, 5155.5549, 5155.6012, 5155.6475, 5155.6937, 5155.7400, 5155.7863, 5155.8325, 5155.8788, 5155.9250, 5155.9713, 5156.0175, 5156.0638, 5156.1100, 5156.1562, 5156.2025, 5156.2487, 5156.2949, 5156.3411, 5156.3874, 5156.4336, 5156.4798, 5156.5260, 5156.5722, 5156.6184, 5156.6646, 5156.7108, 5156.7570, 5156.8032, 5156.8494, 5156.8955, 5156.9417, 5156.9879, 
5157.0341, 5157.0802, 5157.1264, 5157.1726, 5157.2187, 5157.2649, 5157.3111, 5157.3572, 5157.4034, 5157.4495, 5157.4956, 5157.5418, 5157.5879, 5157.6341, 5157.6802, 5157.7263, 5157.7724, 5157.8186, 5157.8647, 5157.9108, 5157.9569, 5158.0030, 5158.0491, 5158.0952, 5158.1413, 5158.1874, 5158.2335, 5158.2796, 5158.3257, 5158.3718, 5158.4178, 5158.4639, 5158.5100, 5158.5561, 5158.6021, 5158.6482, 5158.6943, 5158.7403, 5158.7864, 5158.8324, 5158.8785, 5158.9245, 5158.9706, 5159.0166, 5159.0626, 5159.1087, 5159.1547, 5159.2007, 5159.2467, 5159.2928, 5159.3388, 5159.3848, 5159.4308, 5159.4768, 5159.5228, 5159.5688, 5159.6148, 5159.6608, 5159.7068, 5159.7528, 5159.7988, 5159.8448, 5159.8907, 5159.9367, 5159.9827, 5160.0287, 5160.0746, 5160.1206, 5160.1665, 5160.2125, 5160.2585, 5160.3044, 5160.3504, 5160.3963, 5160.4422, 5160.4882, 5160.5341, 5160.5800, 5160.6260, 5160.6719, 5160.7178, 5160.7637, 5160.8097, 5160.8556, 5160.9015, 5160.9474, 5160.9933, 5161.0392, 5161.0851, 5161.1310, 5161.1769, 5161.2228, 5161.2686, 
5161.3145, 5161.3604, 5161.4063, 5161.4521, 5161.4980, 5161.5439, 5161.5897, 5161.6356, 5161.6815, 5161.7273, 5161.7732, 5161.8190, 5161.8648, 5161.9107, 5161.9565, 5162.0024, 5162.0482, 5162.0940, 5162.1398, 5162.1857, 5162.2315, 5162.2773, 5162.3231, 5162.3689, 5162.4147, 5162.4605, 5162.5063, 5162.5521, 5162.5979, 5162.6437, 5162.6895, 5162.7353, 5162.7810, 5162.8268, 5162.8726, 5162.9184, 5162.9641, 5163.0099, 5163.0557, 5163.1014, 5163.1472, 5163.1929, 5163.2387, 5163.2844, 5163.3302, 5163.3759, 5163.4216, 5163.4674, 5163.5131, 5163.5588, 5163.6045, 5163.6503, 5163.6960, 5163.7417, 5163.7874, 5163.8331, 5163.8788, 5163.9245, 5163.9702, 5164.0159, 5164.0616, 5164.1073, 5164.1530, 5164.1987, 5164.2443, 5164.2900, 5164.3357, 5164.3814, 5164.4270, 5164.4727, 5164.5183, 5164.5640, 5164.6096, 5164.6553, 5164.7009, 5164.7466, 5164.7922, 5164.8379, 5164.8835, 5164.9291, 5164.9748, 5165.0204, 5165.0660, 5165.1116, 5165.1572, 5165.2029, 5165.2485, 5165.2941, 5165.3397, 5165.3853, 5165.4309, 5165.4765, 5165.5220, 
5165.5676, 5165.6132, 5165.6588, 5165.7044, 5165.7500, 5165.7955, 5165.8411, 5165.8867, 5165.9322, 5165.9778, 5166.0233, 5166.0689, 5166.1144, 5166.1600, 5166.2055, 5166.2511, 5166.2966, 5166.3421, 5166.3877, 5166.4332, 5166.4787, 5166.5242, 5166.5697, 5166.6153, 5166.6608, 5166.7063, 5166.7518, 5166.7973, 5166.8428, 5166.8883, 5166.9338, 5166.9792, 5167.0247, 5167.0702, 5167.1157, 5167.1612, 5167.2066, 5167.2521, 5167.2976, 5167.3430, 5167.3885, 5167.4340, 5167.4794, 5167.5249, 5167.5703, 5167.6158, 5167.6612, 5167.7066, 5167.7521, 5167.7975, 5167.8429, 5167.8883, 5167.9338, 5167.9792, 5168.0246, 5168.0700, 5168.1154, 5168.1608, 5168.2062, 5168.2516, 5168.2970, 5168.3424, 5168.3878, 5168.4332, 5168.4786, 5168.5240, 5168.5693, 5168.6147, 5168.6601, 5168.7054, 5168.7508, 5168.7962, 5168.8415, 5168.8869, 5168.9322, 5168.9776, 5169.0229, 5169.0683, 5169.1136, 5169.1589, 5169.2043, 5169.2496, 5169.2949, 5169.3403, 5169.3856, 5169.4309, 5169.4762, 5169.5215, 5169.5668, 5169.6121, 5169.6574, 5169.7027, 5169.7480, 
5169.7933, 5169.8386, 5169.8839, 5169.9292, 5169.9744, 5170.0197, 5170.0650, 5170.1103, 5170.1555, 5170.2008, 5170.2460, 5170.2913, 5170.3366, 5170.3818, 5170.4271, 5170.4723, 5170.5175, 5170.5628, 5170.6080, 5170.6532, 5170.6985, 5170.7437, 5170.7889, 5170.8341, 5170.8793, 5170.9246, 5170.9698, 5171.0150, 5171.0602, 5171.1054, 5171.1506, 5171.1958, 5171.2409, 5171.2861, 5171.3313, 5171.3765, 5171.4217, 5171.4668, 5171.5120, 5171.5572, 5171.6023, 5171.6475, 5171.6927, 5171.7378, 5171.7830, 5171.8281, 5171.8733, 5171.9184, 5171.9635, 5172.0087, 5172.0538, 5172.0989, 5172.1441, 5172.1892, 5172.2343, 5172.2794, 5172.3245, 5172.3696, 5172.4147, 5172.4598, 5172.5049, 5172.5500, 5172.5951, 5172.6402, 5172.6853, 5172.7304, 5172.7755, 5172.8205, 5172.8656, 5172.9107, 5172.9558, 5173.0008, 5173.0459, 5173.0909, 5173.1360, 5173.1810, 5173.2261, 5173.2711, 5173.3162, 5173.3612, 5173.4063, 5173.4513, 5173.4963, 5173.5413, 5173.5864, 5173.6314, 5173.6764, 5173.7214, 5173.7664, 5173.8114, 5173.8564, 5173.9014, 5173.9464, 
5173.9914, 5174.0364, 5174.0814, 5174.1264, 5174.1714, 5174.2164, 5174.2613, 5174.3063, 5174.3513, 5174.3962, 5174.4412, 5174.4862, 5174.5311, 5174.5761, 5174.6210, 5174.6660, 5174.7109, 5174.7558, 5174.8008, 5174.8457, 5174.8906, 5174.9356, 5174.9805, 5175.0254, 5175.0703, 5175.1152, 5175.1602, 5175.2051, 5175.2500, 5175.2949, 5175.3398, 5175.3847, 5175.4296, 5175.4744, 5175.5193, 5175.5642, 5175.6091, 5175.6540, 5175.6988, 5175.7437, 5175.7886, 5175.8334, 5175.8783, 5175.9232, 5175.9680, 5176.0129, 5176.0577, 5176.1025, 5176.1474, 5176.1922, 5176.2371, 5176.2819, 5176.3267, 5176.3715, 5176.4164, 5176.4612, 5176.5060, 5176.5508, 5176.5956, 5176.6404, 5176.6852, 5176.7300, 5176.7748, 5176.8196, 5176.8644, 5176.9092, 5176.9540, 5176.9987, 5177.0435, 5177.0883, 5177.1331, 5177.1778, 5177.2226, 5177.2674, 5177.3121, 5177.3569, 5177.4016, 5177.4464, 5177.4911, 5177.5358, 5177.5806, 5177.6253, 5177.6701, 5177.7148, 5177.7595, 5177.8042, 5177.8489, 5177.8937, 5177.9384, 5177.9831, 5178.0278, 5178.0725, 5178.1172, 
5178.1619, 5178.2066, 5178.2513, 5178.2960, 5178.3406, 5178.3853, 5178.4300, 5178.4747, 5178.5193, 5178.5640, 5178.6087, 5178.6533, 5178.6980, 5178.7426, 5178.7873, 5178.8319, 5178.8766, 5178.9212, 5178.9659, 5179.0105, 5179.0551, 5179.0998, 5179.1444, 5179.1890, 5179.2336, 5179.2782, 5179.3229, 5179.3675, 5179.4121, 5179.4567, 5179.5013, 5179.5459, 5179.5905, 5179.6350, 5179.6796, 5179.7242, 5179.7688, 5179.8134, 5179.8579, 5179.9025, 5179.9471, 5179.9917, 5180.0362, 5180.0808, 5180.1253, 5180.1699, 5180.2144, 5180.2590, 5180.3035, 5180.3480, 5180.3926, 5180.4371, 5180.4816, 5180.5262, 5180.5707, 5180.6152, 5180.6597, 5180.7042, 5180.7488, 5180.7933, 5180.8378, 5180.8823, 5180.9268, 5180.9712, 5181.0157, 5181.0602, 5181.1047, 5181.1492, 5181.1937, 5181.2381, 5181.2826, 5181.3271, 5181.3715, 5181.4160, 5181.4605, 5181.5049, 5181.5494, 5181.5938, 5181.6383, 5181.6827, 5181.7271, 5181.7716, 5181.8160, 5181.8604, 5181.9049, 5181.9493, 5181.9937, 5182.0381, 5182.0825, 5182.1269, 5182.1714, 5182.2158, 5182.2602, 
5182.3046, 5182.3489, 5182.3933, 5182.4377, 5182.4821, 5182.5265, 5182.5709, 5182.6152, 5182.6596, 5182.7040, 5182.7483, 5182.7927, 5182.8371, 5182.8814, 5182.9258, 5182.9701, 5183.0145, 5183.0588, 5183.1031, 5183.1475, 5183.1918, 5183.2361, 5183.2805, 5183.3248, 5183.3691, 5183.4134, 5183.4577, 5183.5020, 5183.5463, 5183.5906, 5183.6349, 5183.6792, 5183.7235, 5183.7678, 5183.8121, 5183.8564, 5183.9007, 5183.9450, 5183.9892, 5184.0335, 5184.0778, 5184.1220, 5184.1663, 5184.2106, 5184.2548, 5184.2991, 5184.3433, 5184.3876, 5184.4318, 5184.4760, 5184.5203, 5184.5645, 5184.6087, 5184.6530, 5184.6972, 5184.7414, 5184.7856, 5184.8298, 5184.8740, 5184.9182, 5184.9624, 5185.0066, 5185.0508, 5185.0950, 5185.1392, 5185.1834, 5185.2276, 5185.2718, 5185.3159, 5185.3601, 5185.4043, 5185.4485, 5185.4926, 5185.5368, 5185.5809, 5185.6251, 5185.6692, 5185.7134, 5185.7575, 5185.8017, 5185.8458, 5185.8900, 5185.9341, 5185.9782, 5186.0223, 5186.0665, 5186.1106, 5186.1547, 5186.1988, 5186.2429, 5186.2870, 5186.3311, 5186.3752, 
5186.4193, 5186.4634, 5186.5075, 5186.5516, 5186.5957, 5186.6398, 5186.6838, 5186.7279, 5186.7720, 5186.8160, 5186.8601, 5186.9042, 5186.9482, 5186.9923, 5187.0363, 5187.0804, 5187.1244, 5187.1685, 5187.2125, 5187.2565, 5187.3006, 5187.3446, 5187.3886, 5187.4326, 5187.4767, 5187.5207, 5187.5647, 5187.6087, 5187.6527, 5187.6967, 5187.7407, 5187.7847, 5187.8287, 5187.8727, 5187.9167, 5187.9606, 5188.0046, 5188.0486, 5188.0926, 5188.1365, 5188.1805, 5188.2245, 5188.2684, 5188.3124, 5188.3563, 5188.4003, 5188.4442, 5188.4882, 5188.5321, 5188.5761, 5188.6200, 5188.6639, 5188.7079, 5188.7518, 5188.7957, 5188.8396, 5188.8835, 5188.9274, 5188.9713, 5189.0153, 5189.0592, 5189.1031, 5189.1469, 5189.1908, 5189.2347, 5189.2786, 5189.3225, 5189.3664, 5189.4102, 5189.4541, 5189.4980, 5189.5419, 5189.5857, 5189.6296, 5189.6734, 5189.7173, 5189.7611, 5189.8050, 5189.8488, 5189.8927, 5189.9365, 5189.9803, 5190.0242, 5190.0680, 5190.1118, 5190.1556, 5190.1995, 5190.2433, 5190.2871, 5190.3309, 5190.3747, 5190.4185, 5190.4623, 
5190.5061, 5190.5499, 5190.5937, 5190.6374, 5190.6812, 5190.7250, 5190.7688, 5190.8125, 5190.8563, 5190.9001, 5190.9438, 5190.9876, 5191.0314, 5191.0751, 5191.1189, 5191.1626, 5191.2063, 5191.2501, 5191.2938, 5191.3376, 5191.3813, 5191.4250, 5191.4687, 5191.5125, 5191.5562, 5191.5999, 5191.6436, 5191.6873, 5191.7310, 5191.7747, 5191.8184, 5191.8621, 5191.9058, 5191.9495, 5191.9932, 5192.0368, 5192.0805, 5192.1242, 5192.1679, 5192.2115, 5192.2552, 5192.2988, 5192.3425, 5192.3862, 5192.4298, 5192.4735, 5192.5171, 5192.5607, 5192.6044, 5192.6480, 5192.6916, 5192.7353, 5192.7789, 5192.8225, 5192.8661, 5192.9098, 5192.9534, 5192.9970, 5193.0406, 5193.0842, 5193.1278, 5193.1714, 5193.2150, 5193.2586, 5193.3021, 5193.3457, 5193.3893, 5193.4329, 5193.4765, 5193.5200, 5193.5636, 5193.6072, 5193.6507, 5193.6943, 5193.7378, 5193.7814, 5193.8249, 5193.8685, 5193.9120, 5193.9555, 5193.9991, 5194.0426, 5194.0861, 5194.1297, 5194.1732, 5194.2167, 5194.2602, 5194.3037, 5194.3472, 5194.3907, 5194.4342, 5194.4777, 5194.5212, 
5194.5647, 5194.6082, 5194.6517, 5194.6952, 5194.7387, 5194.7821, 5194.8256, 5194.8691, 5194.9125, 5194.9560, 5194.9995, 5195.0429, 5195.0864, 5195.1298, 5195.1733, 5195.2167, 5195.2601, 5195.3036, 5195.3470, 5195.3904, 5195.4339, 5195.4773, 5195.5207, 5195.5641, 5195.6075, 5195.6509, 5195.6943, 5195.7377, 5195.7811, 5195.8245, 5195.8679, 5195.9113, 5195.9547, 5195.9981, 5196.0415, 5196.0849, 5196.1282, 5196.1716, 5196.2150, 5196.2583, 5196.3017, 5196.3450, 5196.3884, 5196.4318, 5196.4751, 5196.5184, 5196.5618, 5196.6051, 5196.6485, 5196.6918, 5196.7351, 5196.7784, 5196.8218, 5196.8651, 5196.9084, 5196.9517, 5196.9950, 5197.0383, 5197.0816, 5197.1249, 5197.1682, 5197.2115, 5197.2548, 5197.2981, 5197.3414, 5197.3846, 5197.4279, 5197.4712, 5197.5145, 5197.5577, 5197.6010, 5197.6442, 5197.6875, 5197.7308, 5197.7740, 5197.8173, 5197.8605, 5197.9037, 5197.9470, 5197.9902, 5198.0334, 5198.0767, 5198.1199, 5198.1631, 5198.2063, 5198.2495, 5198.2927, 5198.3359, 5198.3792, 5198.4224, 5198.4656, 5198.5087, 5198.5519, 
5198.5951, 5198.6383, 5198.6815, 5198.7247, 5198.7678, 5198.8110, 5198.8542, 5198.8973, 5198.9405, 5198.9837, 5199.0268, 5199.0700, 5199.1131, 5199.1563, 5199.1994, 5199.2425, 5199.2857, 5199.3288, 5199.3719, 5199.4151, 5199.4582, 5199.5013, 5199.5444, 5199.5875, 5199.6306, 5199.6737, 5199.7168, 5199.7599, 5199.8030, 5199.8461, 5199.8892, 5199.9323, 5199.9754, 5200.0185, 5200.0615, 5200.1046, 5200.1477, 5200.1907, 5200.2338, 5200.2769, 5200.3199, 5200.3630, 5200.4060, 5200.4491, 5200.4921, 5200.5351, 5200.5782, 5200.6212, 5200.6642, 5200.7073, 5200.7503, 5200.7933, 5200.8363, 5200.8793, 5200.9224, 5200.9654, 5201.0084, 5201.0514, 5201.0944, 5201.1374, 5201.1803, 5201.2233, 5201.2663, 5201.3093, 5201.3523, 5201.3952, 5201.4382, 5201.4812, 5201.5241, 5201.5671, 5201.6101, 5201.6530, 5201.6960, 5201.7389, 5201.7819, 5201.8248, 5201.8677, 5201.9107, 5201.9536, 5201.9965, 5202.0395, 5202.0824, 5202.1253, 5202.1682, 5202.2111, 5202.2540, 5202.2969, 5202.3398, 5202.3827, 5202.4256, 5202.4685, 5202.5114, 5202.5543, 
5202.5972, 5202.6401, 5202.6829, 5202.7258, 5202.7687, 5202.8115, 5202.8544, 5202.8973, 5202.9401, 5202.9830, 5203.0258, 5203.0687, 5203.1115, 5203.1543, 5203.1972, 5203.2400, 5203.2828, 5203.3257, 5203.3685, 5203.4113, 5203.4541, 5203.4969, 5203.5397, 5203.5825, 5203.6254, 5203.6682, 5203.7109, 5203.7537, 5203.7965, 5203.8393, 5203.8821, 5203.9249, 5203.9677, 5204.0104, 5204.0532, 5204.0960, 5204.1387, 5204.1815, 5204.2242, 5204.2670, 5204.3097, 5204.3525, 5204.3952, 5204.4380, 5204.4807, 5204.5234, 5204.5662, 5204.6089, 5204.6516, 5204.6943, 5204.7371, 5204.7798, 5204.8225, 5204.8652, 5204.9079, 5204.9506, 5204.9933, 5205.0360, 5205.0787, 5205.1214, 5205.1641, 5205.2067, 5205.2494, 5205.2921, 5205.3348, 5205.3774, 5205.4201, 5205.4628, 5205.5054, 5205.5481, 5205.5907, 5205.6334, 5205.6760, 5205.7186, 5205.7613, 5205.8039, 5205.8466, 5205.8892, 5205.9318, 5205.9744, 5206.0170, 5206.0597, 5206.1023, 5206.1449, 5206.1875, 5206.2301, 5206.2727, 5206.3153, 5206.3579, 5206.4005, 5206.4430, 5206.4856, 5206.5282, 
5206.5708, 5206.6133, 5206.6559, 5206.6985, 5206.7410, 5206.7836, 5206.8262, 5206.8687, 5206.9113, 5206.9538, 5206.9963, 5207.0389, 5207.0814, 5207.1240, 5207.1665, 5207.2090, 5207.2515, 5207.2940, 5207.3366, 5207.3791, 5207.4216, 5207.4641, 5207.5066, 5207.5491, 5207.5916, 5207.6341, 5207.6766, 5207.7191, 5207.7615, 5207.8040, 5207.8465, 5207.8890, 5207.9314, 5207.9739, 5208.0164, 5208.0588, 5208.1013, 5208.1437, 5208.1862, 5208.2286, 5208.2711, 5208.3135, 5208.3559, 5208.3984, 5208.4408, 5208.4832, 5208.5257, 5208.5681, 5208.6105, 5208.6529, 5208.6953, 5208.7377, 5208.7801, 5208.8225, 5208.8649, 5208.9073, 5208.9497, 5208.9921, 5209.0345, 5209.0769, 5209.1192, 5209.1616, 5209.2040, 5209.2463, 5209.2887, 5209.3311, 5209.3734, 5209.4158, 5209.4581, 5209.5005, 5209.5428, 5209.5852, 5209.6275, 5209.6698, 5209.7122, 5209.7545, 5209.7968, 5209.8391, 5209.8814, 5209.9238, 5209.9661, 5210.0084, 5210.0507, 5210.0930, 5210.1353, 5210.1776, 5210.2199, 5210.2622, 5210.3044, 5210.3467, 5210.3890, 5210.4313, 5210.4735, 
5210.5158, 5210.5581, 5210.6003, 5210.6426, 5210.6848, 5210.7271, 5210.7693, 5210.8116, 5210.8538, 5210.8961, 5210.9383, 5210.9805, 5211.0228, 5211.0650, 5211.1072, 5211.1494, 5211.1916, 5211.2338, 5211.2761, 5211.3183, 5211.3605, 5211.4027, 5211.4448, 5211.4870, 5211.5292, 5211.5714, 5211.6136, 5211.6558, 5211.6979, 5211.7401, 5211.7823, 5211.8244, 5211.8666, 5211.9088, 5211.9509, 5211.9931, 5212.0352, 5212.0774, 5212.1195, 5212.1616, 5212.2038, 5212.2459, 5212.2880, 5212.3302, 5212.3723, 5212.4144, 5212.4565, 5212.4986, 5212.5407, 5212.5828, 5212.6249, 5212.6670, 5212.7091, 5212.7512, 5212.7933, 5212.8354, 5212.8775, 5212.9196, 5212.9616, 5213.0037, 5213.0458, 5213.0878, 5213.1299, 5213.1720, 5213.2140, 5213.2561, 5213.2981, 5213.3402, 5213.3822, 5213.4242, 5213.4663, 5213.5083, 5213.5503, 5213.5924, 5213.6344, 5213.6764, 5213.7184, 5213.7604, 5213.8024, 5213.8444, 5213.8864, 5213.9284, 5213.9704, 5214.0124, 5214.0544, 5214.0964, 5214.1384, 5214.1804, 5214.2223, 5214.2643, 5214.3063, 5214.3482, 5214.3902, 
5214.4322, 5214.4741, 5214.5161, 5214.5580, 5214.6000, 5214.6419, 5214.6838, 5214.7258, 5214.7677, 5214.8096, 5214.8516, 5214.8935, 5214.9354, 5214.9773, 5215.0192, 5215.0611, 5215.1030, 5215.1449, 5215.1868, 5215.2287, 5215.2706, 5215.3125, 5215.3544, 5215.3963, 5215.4382, 5215.4800, 5215.5219, 5215.5638, 5215.6056, 5215.6475, 5215.6894, 5215.7312, 5215.7731, 5215.8149, 5215.8568, 5215.8986, 5215.9404, 5215.9823, 5216.0241, 5216.0659, 5216.1078, 5216.1496, 5216.1914, 5216.2332, 5216.2750, 5216.3168, 5216.3586, 5216.4004, 5216.4422, 5216.4840, 5216.5258, 5216.5676, 5216.6094, 5216.6512, 5216.6930, 5216.7347, 5216.7765, 5216.8183, 5216.8600, 5216.9018, 5216.9436, 5216.9853, 5217.0271, 5217.0688, 5217.1106, 5217.1523, 5217.1940, 5217.2358, 5217.2775, 5217.3192, 5217.3610, 5217.4027, 5217.4444, 5217.4861, 5217.5278, 5217.5695, 5217.6112, 5217.6529, 5217.6946, 5217.7363, 5217.7780, 5217.8197, 5217.8614, 5217.9031, 5217.9448, 5217.9864, 5218.0281, 5218.0698, 5218.1114, 5218.1531, 5218.1948, 5218.2364, 5218.2781, 
5218.3197, 5218.3614, 5218.4030, 5218.4446, 5218.4863, 5218.5279, 5218.5695, 5218.6112, 5218.6528, 5218.6944, 5218.7360, 5218.7776, 5218.8192, 5218.8608, 5218.9024, 5218.9440, 5218.9856, 5219.0272, 5219.0688, 5219.1104, 5219.1520, 5219.1936, 5219.2351, 5219.2767, 5219.3183, 5219.3598, 5219.4014, 5219.4430, 5219.4845, 5219.5261, 5219.5676, 5219.6092, 5219.6507, 5219.6922, 5219.7338, 5219.7753, 5219.8168, 5219.8584, 5219.8999, 5219.9414, 5219.9829, 5220.0244, 5220.0659, 5220.1074, 5220.1489, 5220.1904, 5220.2319, 5220.2734, 5220.3149, 5220.3564, 5220.3979, 5220.4393, 5220.4808, 5220.5223, 5220.5638, 5220.6052, 5220.6467, 5220.6881, 5220.7296, 5220.7710, 5220.8125, 5220.8539, 5220.8954, 5220.9368, 5220.9783, 5221.0197, 5221.0611, 5221.1025, 5221.1440, 5221.1854, 5221.2268, 5221.2682, 5221.3096, 5221.3510, 5221.3924, 5221.4338, 5221.4752, 5221.5166, 5221.5580, 5221.5994, 5221.6407, 5221.6821, 5221.7235, 5221.7649, 5221.8062, 5221.8476, 5221.8890, 5221.9303, 5221.9717, 5222.0130, 5222.0544, 5222.0957, 5222.1370, 
5222.1784, 5222.2197, 5222.2610, 5222.3024, 5222.3437, 5222.3850, 5222.4263, 5222.4676, 5222.5090, 5222.5503, 5222.5916, 5222.6329, 5222.6742, 5222.7155, 5222.7567, 5222.7980, 5222.8393, 5222.8806, 5222.9219, 5222.9631, 5223.0044, 5223.0457, 5223.0869, 5223.1282, 5223.1695, 5223.2107, 5223.2520, 5223.2932, 5223.3345, 5223.3757, 5223.4169, 5223.4582, 5223.4994, 5223.5406, 5223.5818, 5223.6231, 5223.6643, 5223.7055, 5223.7467, 5223.7879, 5223.8291, 5223.8703, 5223.9115, 5223.9527, 5223.9939, 5224.0351, 5224.0763, 5224.1174, 5224.1586, 5224.1998, 5224.2410, 5224.2821, 5224.3233, 5224.3644, 5224.4056, 5224.4467, 5224.4879, 5224.5290, 5224.5702, 5224.6113, 5224.6525, 5224.6936, 5224.7347, 5224.7758, 5224.8170, 5224.8581, 5224.8992, 5224.9403, 5224.9814, 5225.0225, 5225.0636, 5225.1047, 5225.1458, 5225.1869, 5225.2280, 5225.2691, 5225.3102, 5225.3512, 5225.3923, 5225.4334, 5225.4745, 5225.5155, 5225.5566, 5225.5976, 5225.6387, 5225.6798, 5225.7208, 5225.7618, 5225.8029, 5225.8439, 5225.8850, 5225.9260, 5225.9670, 
5226.0080, 5226.0491, 5226.0901, 5226.1311, 5226.1721, 5226.2131, 5226.2541, 5226.2951, 5226.3361, 5226.3771, 5226.4181, 5226.4591, 5226.5001, 5226.5411, 5226.5820, 5226.6230, 5226.6640, 5226.7049, 5226.7459, 5226.7869, 5226.8278, 5226.8688, 5226.9097, 5226.9507, 5226.9916, 5227.0326, 5227.0735, 5227.1144, 5227.1554, 5227.1963, 5227.2372, 5227.2781, 5227.3190, 5227.3600, 5227.4009, 5227.4418, 5227.4827, 5227.5236, 5227.5645, 5227.6054, 5227.6463, 5227.6871, 5227.7280, 5227.7689, 5227.8098, 5227.8507, 5227.8915, 5227.9324, 5227.9733, 5228.0141, 5228.0550, 5228.0958, 5228.1367, 5228.1775, 5228.2184, 5228.2592, 5228.3000, 5228.3409, 5228.3817, 5228.4225, 5228.4633, 5228.5042, 5228.5450, 5228.5858, 5228.6266, 5228.6674, 5228.7082, 5228.7490, 5228.7898, 5228.8306, 5228.8714, 5228.9122, 5228.9529, 5228.9937, 5229.0345, 5229.0753, 5229.1160, 5229.1568, 5229.1976, 5229.2383, 5229.2791, 5229.3198, 5229.3606, 5229.4013, 5229.4421, 5229.4828, 5229.5235, 5229.5643, 5229.6050, 5229.6457, 5229.6864, 5229.7272, 5229.7679, 
5229.8086, 5229.8493, 5229.8900, 5229.9307, 5229.9714, 5230.0121, 5230.0528, 5230.0935, 5230.1341, 5230.1748, 5230.2155, 5230.2562, 5230.2968, 5230.3375, 5230.3782, 5230.4188, 5230.4595, 5230.5001, 5230.5408, 5230.5814, 5230.6221, 5230.6627, 5230.7034, 5230.7440, 5230.7846, 5230.8253, 5230.8659, 5230.9065, 5230.9471, 5230.9877, 5231.0283, 5231.0689, 5231.1095, 5231.1501, 5231.1907, 5231.2313, 5231.2719, 5231.3125, 5231.3531, 5231.3937, 5231.4342, 5231.4748, 5231.5154, 5231.5559, 5231.5965, 5231.6371, 5231.6776, 5231.7182, 5231.7587, 5231.7993, 5231.8398, 5231.8803, 5231.9209, 5231.9614, 5232.0019, 5232.0425, 5232.0830, 5232.1235, 5232.1640, 5232.2045, 5232.2450, 5232.2855, 5232.3260, 5232.3665, 5232.4070, 5232.4475, 5232.4880, 5232.5285, 5232.5690, 5232.6095, 5232.6499, 5232.6904, 5232.7309, 5232.7713, 5232.8118, 5232.8523, 5232.8927, 5232.9332, 5232.9736, 5233.0140, 5233.0545, 5233.0949, 5233.1354, 5233.1758, 5233.2162, 5233.2566, 5233.2971, 5233.3375, 5233.3779, 5233.4183, 5233.4587, 5233.4991, 5233.5395, 
5233.5799, 5233.6203, 5233.6607, 5233.7011, 5233.7414, 5233.7818, 5233.8222, 5233.8626, 5233.9029, 5233.9433, 5233.9837, 5234.0240, 5234.0644, 5234.1047, 5234.1451, 5234.1854, 5234.2258, 5234.2661, 5234.3064, 5234.3468, 5234.3871, 5234.4274, 5234.4678, 5234.5081, 5234.5484, 5234.5887, 5234.6290, 5234.6693, 5234.7096, 5234.7499, 5234.7902, 5234.8305, 5234.8708, 5234.9111, 5234.9513, 5234.9916, 5235.0319, 5235.0722, 5235.1124, 5235.1527, 5235.1930, 5235.2332, 5235.2735, 5235.3137, 5235.3540, 5235.3942, 5235.4344, 5235.4747, 5235.5149, 5235.5551, 5235.5954, 5235.6356, 5235.6758, 5235.7160, 5235.7562, 5235.7964, 5235.8367, 5235.8769, 5235.9171, 5235.9573, 5235.9974, 5236.0376, 5236.0778, 5236.1180, 5236.1582, 5236.1984, 5236.2385, 5236.2787};
    double min_sep = get_min_sep(wl, 2298);
    printf("min_sep = %.5f\n", min_sep);
    cholmod_sparse *A = create_sparse(wl, 2298, min_sep, 1.0, 1.0, &c);
    cholmod_factor *L ;
    L = cholmod_analyze (A, &c) ;		    

    printf("is Supernodal factorization = %d\n", L->is_super);
    printf("LDL' = 0, LL' = 1; is_ll = %d\n", L->is_ll);
    printf("Status is = %d\n", c.status);
    
    //cholmod_print_perm(L->Perm, A->nrow, A->nrow, "Perm", &c);
    //cholmod_print_factor(L, "L", &c);
    cholmod_factorize (A, L, &c) ;		    
    printf("L->minor = %d\n", (int) L->minor);
    printf("rcond = %.7f\n", cholmod_rcond(L, &c));

    printf("Logdet = %.7f\n", get_logdet(L));
    mu_assert_close(-15991.257711869774, get_logdet(L), 1E-5); //checked by Julia

    cholmod_free_sparse(&A, &c); 
    cholmod_free_factor(&L, &c);
}

MU_TEST(test_logdet)
{

    printf("\ntest_logdet\n");
    c.final_asis = 0;

    //run through all 4 possible cases of the logdet routine
    //is_super set by
    //c.supernodal = CHOLMOD_SIMPLICIAL;
    //c.supernodal = CHOLMOD_SUPERNODAL;
    //
    //is_ll set by
    //c.final_ll = TRUE; //LLt
    //c.final_ll = FALSE; //LDLt
    
    // **************
    //Simplicial LDLt
    // **************
    //is_ll=FALSE, is_super=FALSE
    //N=30
    //create_sparse(wl, 1., 1.)
    //logdet = -0.00134744563566
    
    //c.supernodal = CHOLMOD_SIMPLICIAL;
    //c.final_ll = FALSE; //LDLt

    int NN = 30;
    double wl[NN];
    linspace(wl, NN, 5100., 5200.);
    min_sep = get_min_sep(wl, NN);

    cholmod_sparse *A = create_sparse(wl, NN, min_sep, 1.0, 1.0, &c);
    cholmod_factor *L = cholmod_analyze (A, &c) ;		    
    cholmod_factorize (A, L, &c) ;		    
    printf("is_ll %d, is_super %d\n", L->is_ll, L->is_super);
    mu_assert_int_eq(0, L->is_ll);
    mu_assert_int_eq(0, L->is_super);
    mu_assert_close(-0.00134744563566, get_logdet(L), 1E-6);

    // *************
    //Simplicial LLt
    // *************
    //is_ll=TRUE, is_super=FALSE
    //N=30
    //create_sparse(wl, 1., 1.)
    //logdet = -0.00134744563566
    c.supernodal = CHOLMOD_SIMPLICIAL;
    c.final_ll = TRUE; //LLt

    A = create_sparse(wl, NN, min_sep, 1.0, 1.0, &c);
    L = cholmod_analyze (A, &c) ;		    
    cholmod_factorize (A, L, &c) ;		    
    printf("is_ll %d, is_super %d\n", L->is_ll, L->is_super);
    mu_assert_int_eq(1, L->is_ll);
    mu_assert_int_eq(0, L->is_super);
    mu_assert_close(-0.00134744563566, get_logdet(L), 1E-6);
    
    // **************
    //Supernodal LDLt
    // **************
    //is_ll=FALSE, is_super=TRUE
    //N=3000
    //create_sparse(wl, 1., 1.)
    //logdet = -23248.95169672
    
    //This type is not used, according to pg 76
    
    // *************
    //Supernodal LLt
    // *************
    //is_ll=TRUE, is_super=TRUE
    //N=3000
    //create_sparse(wl, 1., 1.)
    //logdet = -23248.95169672
    c.supernodal = CHOLMOD_SUPERNODAL;
    c.final_ll = TRUE; //LLt

    NN = 3000;
    double wl2[NN];
    linspace(wl2, NN, 5100., 5200.);
    min_sep = get_min_sep(wl2, NN);

    A = create_sparse(wl2, NN, min_sep, 1.0, 1.0, &c);
    L = cholmod_analyze (A, &c) ;		    
    cholmod_factorize (A, L, &c) ;		    
    printf("is_ll %d, is_super %d\n", L->is_ll, L->is_super);
    mu_assert_int_eq(1, L->is_ll);
    mu_assert_int_eq(1, L->is_super);
    mu_assert_close(-23248.95169672, get_logdet(L), 1E-6);

    cholmod_free_sparse(&A, &c); 
    cholmod_free_factor(&L, &c);

}

MU_TEST(test_create_sparse_region)
{
    printf("\ntest_create_sparse_region\n");
    //See if the sparse matrix is allocated with the correct properties
    cholmod_sparse *A = create_sparse_region(wl, N, 5, 1.0, 5150., 1, &c);
    //Test to see what kind of matrix this is

    //cholmod_print_sparse(A, "A", &c);
    cholmod_free_sparse(&A, &c); 

}

MU_TEST(test_logdet_region)
{
    printf("\ntest_logdet_region\n");

    cholmod_sparse *A = create_sparse(wl, N, min_sep, 1.0, 1.0, &c); //often slow
    cholmod_sparse *C = create_sparse_region(wl, N, 5, 1.0, 5150., 1., &c);
    double alpha [2] = {1,0}, beta [2] = {1,0} ;	    // basic scalars 
    cholmod_sparse *F = cholmod_add(A, C, alpha, beta, TRUE, TRUE, &c);
    cholmod_factor *L = cholmod_analyze (F, &c) ;		    
    cholmod_factorize (F, L, &c) ;  //tends to be slow    
    mu_assert_close(-23248.79272934225, get_logdet(L), 1E-6);
    printf("logdet region=%.5f\n",get_logdet(L));

    cholmod_free_sparse(&A, &c); 
    cholmod_free_sparse(&F, &c); 
    cholmod_free_factor(&L, &c);
}

MU_TEST(test_updown)
{
    printf("\ntest_updown\n");
    cholmod_sparse *A = create_sparse(wl, N, min_sep, 1.0, 1., &c);
    cholmod_factor *L ;
    L = cholmod_analyze (A, &c) ;		    
    cholmod_factorize (A, L, &c) ;		    
    double orig = get_logdet(L);
    printf("logdet is %.2f\n", orig);

    cholmod_sparse *C = create_sparse_region(wl, N, 5, 1.0, 5150., 1., &c);
    cholmod_sparse *F = cholmod_allocate_sparse(A->nrow, A->ncol, A->nzmax, A->sorted, A->packed, A->stype, A->xtype, &c);
    cholmod_transpose_sym(C, 1, L->Perm, F, &c);
    cholmod_sort(F, &c);
    cholmod_updown(TRUE, F, L, &c);
    printf("logdet is %.2f\n", get_logdet(L));

    cholmod_updown(0, F, L, &c);
    double new = get_logdet(L);
    printf("logdet is %.2f\n", new);
    //Check to make sure that we got back to the same point
    mu_assert_double_eq(orig, new);

    cholmod_free_sparse(&A, &c); 
    cholmod_free_sparse(&C, &c); 
    cholmod_free_sparse(&F, &c);
    cholmod_free_factor(&L, &c);
}

MU_TEST(test_chi2)
{
    printf("\ntest_chi2\n");
    cholmod_sparse *A = create_sparse(wl, N, min_sep, 1.0, 1., &c);
    cholmod_factor *L ;
    L = cholmod_analyze (A, &c) ;		    
    cholmod_factorize (A, L, &c);		    
    //Create a vector with the same number of rows as A
    cholmod_dense *r = cholmod_ones (A->nrow, 1, A->xtype, &c) ;   
    //printf("chi2 = %.2f", chi2(r, L, &c));
    mu_assert_close(48.071706650708094, chi2(r, L, &c), 1E-6);
    cholmod_free_dense(&r, &c);
}


MU_TEST_SUITE(test_suite)
{
    MU_SUITE_CONFIGURE(&test_setup, &test_teardown);
    MU_RUN_TEST(test_create_sigma);
    MU_RUN_TEST(test_create_sparse);
    MU_RUN_TEST(test_add_sigma_sparse);
    MU_RUN_TEST(test_factor);
    MU_RUN_TEST(test_factor_real_wl);
    MU_RUN_TEST(test_logdet);
    MU_RUN_TEST(test_create_sparse_region);
    MU_RUN_TEST(test_logdet_region);
    MU_RUN_TEST(test_updown);
    MU_RUN_TEST(test_chi2);
}


int main(int argc, char *argv[])
{
    MU_RUN_SUITE(test_suite);
    MU_REPORT();
    return 0;
    //
    //Set these to disable permutation
    //c.nmethods = 9;
    //c.method[0].ordering = CHOLMOD_NATURAL;
    //c.postorder = 0;
    //

    //printf("Status is = %d\n", c.status);

    return (0) ;
}


//The difference between using CHOLMOD_A and CHOLMOD_LDLt is that the LDLt does not permute the matrix. By default, "AMD" is used to determine the best permutation, which can be retrieved from L->Perm. To get the same answer, you either have to do the same permutation yourself or disable using AMD, so that no permutation is used.
//
//Design a mu_assert_close statement that takes in a precision argument (1e-6) to compare the closeness of two numbers not created from the same routine, but instead copied over by hand.
